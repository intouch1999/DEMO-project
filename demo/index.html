<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>thunder-cash</title>
  <link rel="shortcut icon" type="image/png" href="../src/assets/images/logos/favicon.png" />
  <link rel="stylesheet" href="../src/assets/css/styles.min.css" />
  <style>
    /* Custom CSS for card responsiveness */
    .item-details {
      flex: 1;
    }

    @media (max-width: 768px) {
      /* Adjust container and card layout */
      .table-responsive {
        display: block;
        width: 100%;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }

      .table-responsive td, .table-responsive th {
        white-space: nowrap;
      }
    }

    .img-fluid.rounded {
      transition: transform 0.3s ease; /* Smooth transition for transform */
    }

    .img-fluid.rounded:hover {
      transform: scale(1.1); /* Scale up the image by 10% on hover */
    }

    .card {
      transition: transform 0.2s ease, background-color 0.2s ease; /* Smooth transitions for card */
    }

    .card-body.d-flex.justify-content-between.align-items-center {
      transition: transform 0.2s ease, background-color 0.2s ease; /* Smooth transitions for card-body */
    }

    .card-body.d-flex.justify-content-between.align-items-center:hover {
      transform: scale(1.02); /* Scale up the card-body slightly on hover */
      background-color: #f8f9fa; /* Change background color of card-body on hover */
    }

    .card.col-md-4.shadow-lg.rounded-pill {
      transition: transform 0.2s ease, background-color 0.2s ease; /* Smooth transitions for card */
    }

    .card.col-md-4.shadow-lg.rounded-pill:hover {
      transform: scale(1.02); /* Scale up the card-body slightly on hover */
    }

    .app-header {
      position: fixed;
      width: 100%;
      transition: transform 0.3s ease-in-out, visibility 0.3s ease-in-out;
      z-index: 1000;
    }

    .app-header.hidden {
      transform: translateY(-100%);
      visibility: hidden;
    }
  </style>
</head>

<body>
  <!--  Body Wrapper -->
  <div class="page-wrapper" id="main-wrapper" data-layout="vertical" data-navbarbg="skin6" data-sidebartype="full"
    data-sidebar-position="fixed" data-header-position="fixed">
    <div id="navbar"></div>
    <!--  Main wrapper -->
    <div class="body-wrapper">
      <!--  Header Start -->
      <div id="header"></div>
      <!--  Header End -->
      <div class="container-fluid">
        <div class="card shadow-lg">
          <div class="card-body">
            <h5 class="card-title fw-semibold mb-4">รายการสินค้า</h5>
            <div class="d-flex justify-content-around text-center">
              <div id="days-count" class="card col-md-4 shadow-lg rounded-pill" style="background-color: #5D87FE;"></div>
              <div id="all-count" class="card col-md-4 shadow-lg rounded-pill" style="background-color: #5D87FE;"></div>
            </div>
            <div id="list-menu" class="container mt-4">
              <!-- Table will be dynamically added here -->
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script src="../src/assets/libs/jquery/dist/jquery.min.js"></script>
  <script src="../src/assets/libs/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
  <script src="../src/assets/js/sidebarmenu.js"></script>
  <script src="../src/assets/js/app.min.js"></script>
  <script src="../src/assets/libs/simplebar/dist/simplebar.js"></script>
  <script>
    $(document).ready(function () {
      $("#navbar").load("navbar.html");
      $("#header").load("header.html");

      function fetchItems(page) {
        return fetch(`../api/select_item.php?case=items&page=${page}`, {
          method: 'POST',
          body: JSON.stringify({
            case: 'items',
          }),
        })
        .then(response => {
          if (!response.ok) {
            throw new Error('Network response was not ok');
          }
          return response.json();
        })
        .catch(error => {
          console.error('Error fetching items:', error);
        });
      }

      // Function to render table rows
      function renderTableRow(item) {
        $('#item-table tbody').append(`
          <tr>
            <td>${item.item_id}</td>
            <td>${item.item_name}</td>
            <td>${item.item_type}</td>
            <td>${formatNumberWithCommas(item.item_price)} บาท</td>
            <td>${per_interest(item.item_price, item.item_interest)} บาท</td>
            <td>${addDATE(item.item_d_create, item.item_d_interest)}</td>
            <td>${changeformate(item.item_d_create)}</td>
            <td><img src="../src/assets/images/product/${item.item_pic}" class="img-fluid rounded" style="max-width: 150px; height: auto;" alt="Product Image"></td>
          </tr>
        `);
      }

      function handleFetchAndRender() {
        let page = 1;
        fetchItems(page)
          .then(data => {
            data.forEach(item => {
              renderTableRow(item);
            });
            page++;
          });

        $(window).scroll(function() {
          if ($(window).scrollTop() + $(window).height() >= $(document).height() - 200) {
            fetchItems(page)
              .then(data => {
                data.forEach(item => {
                  renderTableRow(item);
                });
                page++;
              });
          }
        });
      }

      $('#list-menu').html(`
      <div class="table-responsive">
        <table id="item-table" class="table table-hover ">
          <thead >
            <tr>
              <th>รหัสสินค้า</th>
              <th>ชื่อสินค้า</th>
              <th>ประเภทสินค้า</th>
              <th>ราคา</th>
              <th>ราคาดอกเบี้ย</th>
              <th>วันที่ครบกำหนดชำระดอก</th>
              <th>เพิ่มสินค้า</th>
              <th>รูปภาพ</th>
            </tr>
          </thead>
          <tbody>
          </tbody>
        </table>
      </div>
    `);


      handleFetchAndRender();

      const formatNumberWithCommas = (number) => {
        return number.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
      };

      const addDATE = (datetime, days) => {
        let date = new Date(datetime);
        date.setDate(date.getDate() + days);
        let daysOfWeek = ['วันอาทิตย์', 'วันจันทร์', 'วันอังคาร', 'วันพุธ', 'วันพฤหัสบดี', 'วันศุกร์', 'วันเสาร์'];
        let dayName = daysOfWeek[date.getDay()];
        let formattedDate = `${dayName} ${date.getDate()}/${date.getMonth() + 1}/${date.getFullYear()}`;
        return formattedDate;
      };

      const changeformate = (datetime) => {
        let date = new Date(datetime);
        let daysOfWeek = ['วันอาทิตย์', 'วันจันทร์', 'วันอังคาร', 'วันพุธ', 'วันพฤหัสบดี', 'วันศุกร์', 'วันเสาร์'];
        let dayName = daysOfWeek[date.getDay()];
        let formattedDate = `${dayName} ${date.getDate()}/${date.getMonth() + 1}/${date.getFullYear()}`;
        return formattedDate;
      };

      const per_interest = (number, rate) => {
        let num = number * (rate / 100);
        return num.toFixed(2);
      };

      const todayItemCount = () => {
        fetch('../api/select_item.php?case=DayCount', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            case: 'DayCount'
          })
        })
        .then(res => {
          if (!res.ok) {
            throw new Error('Network response was not ok');
          }
          return res.json();
        })
        .then(data => {
          updateTodayItemCount(data);
        })
        .catch(err => {
          console.error('เกิดข้อผิดพลาดในการเชื่อมต่อ:', err);
          alert('เกิดข้อผิดพลาดในการเชื่อมต่อ');
        });
      }

      const updateTodayItemCount = (data) => {
        if ($(window).width() >= 768) { 
          $('#days-count').html(`<h1 class="card-text m-4" style="color: white;">รายการจำนำวันนี้: ${data.todaycount}</h1>`);
        } else {
          $('#days-count').html(`<h5 class="card-text m-4" style="color: white;">รายการจำนำวันนี้: ${data.todaycount}</h5>`);
        }
      }

      const allItemCount = () => {
        fetch('../api/select_item.php?case=AllCount', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            case: 'AllCount'
          })
        })
        .then(res => {
          if (!res.ok) {
            throw new Error('Network response was not ok');
          }
          return res.json();
        })
        .then(data => {
          updateAllItemCount(data); 
        })
        .catch(err => {
          console.error('เกิดข้อผิดพลาดในการเชื่อมต่อ:', err);
          alert('เกิดข้อผิดพลาดในการเชื่อมต่อ');
        });
      }

      const updateAllItemCount = (data) => {
        if ($(window).width() >= 768) {
          $('#all-count').html(`<h1 class="card-text m-4" style="color: white;">รายการทั้งหมด: ${data.allcount}</h1>`);
        } else {
          $('#all-count').html(`<h5 class="card-text m-4" style="color: white;">รายการทั้งหมด: ${data.allcount}</h5>`);
        }
      }

      allItemCount();

      $(window).resize(function() {
        $('#days-count').empty();
        $('#all-count').empty();
        todayItemCount();
        allItemCount();
      });

      todayItemCount();
    });

    let lastScrollTop = 0;

    window.addEventListener('scroll', function() {
      let scrollTop = window.pageYOffset || document.documentElement.scrollTop;

      if (scrollTop > lastScrollTop) {
        $('.app-header').addClass('hidden');
      } else {
        $('.app-header').removeClass('hidden');
      }

      lastScrollTop = scrollTop;
    });
  </script>
</body>

</html>
